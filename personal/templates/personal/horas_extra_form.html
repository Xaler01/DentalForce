{% extends 'base/base.html' %}
{% block page_content %}
<div class="container-fluid">
  <div class="card shadow mb-4">
    <div class="card-header py-3">
      <h6 class="m-0 font-weight-bold text-primary">
        {% if object %}
          <i class="fas fa-edit"></i> Editar Horas Extra - {{ object.fecha|date:"d/m/Y" }}
        {% else %}
          <i class="fas fa-plus"></i> Registrar Horas Extra
        {% endif %}
      </h6>
    </div>
    <div class="card-body">
      <!-- Información sobre Desglose -->
      <div class="alert alert-info mb-4" role="alert">
        <i class="fas fa-lightbulb"></i>
        <strong>¿Cómo funciona?</strong> Solo ingrese el período completo de trabajo.
        <br>El sistema calcula automáticamente:
        <ul class="mb-0 mt-2">
          <li><strong>18:00 - 20:00:</strong> Recargo 25% (horas vespertinas)</li>
          <li><strong>20:00 en adelante:</strong> Recargo 50% (horas nocturnas)</li>
        </ul>
        <br>
        <strong>Ejemplo:</strong> Si registra de 18:00 a 23:15, se crearán automáticamente dos registros:
        <ul class="mb-0 mt-2">
          <li>18:00 - 20:00 → 2h con recargo 25%</li>
          <li>20:00 - 23:15 → 3.25h con recargo 50%</li>
        </ul>
      </div>

      <form method="post">
        {% csrf_token %}
        
        {% if form.non_field_errors %}
        <div class="alert alert-danger" role="alert">
          {{ form.non_field_errors }}
        </div>
        {% endif %}

        <div class="row">
          <div class="col-md-4">
            <div class="form-group">
              {{ form.fecha.label_tag }}
              {{ form.fecha }}
              {% if form.fecha.errors %}<small class="text-danger">{{ form.fecha.errors }}</small>{% endif %}
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-group">
              {{ form.hora_inicio.label_tag }}
              {{ form.hora_inicio }}
              {% if form.hora_inicio.errors %}<small class="text-danger">{{ form.hora_inicio.errors }}</small>{% endif %}
              <small class="form-text text-muted">{{ form.hora_inicio.help_text }}</small>
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-group">
              {{ form.hora_fin.label_tag }}
              {{ form.hora_fin }}
              {% if form.hora_fin.errors %}<small class="text-danger">{{ form.hora_fin.errors }}</small>{% endif %}
              <small class="form-text text-muted">{{ form.hora_fin.help_text }}</small>
            </div>
          </div>
        </div>

        <div class="row mt-2">
          <div class="col-md-12">
            <div class="form-group">
              {{ form.observaciones.label_tag }}
              {{ form.observaciones }}
              {% if form.observaciones.errors %}<small class="text-danger">{{ form.observaciones.errors }}</small>{% endif %}
            </div>
          </div>
        </div>

        <hr class="mt-4 mb-4">
        
        <div class="row">
          <div class="col-md-12">
            <h5 class="text-primary"><i class="fas fa-dollar-sign"></i> Tipo de Compensación</h5>
            <p class="text-muted"><small>Seleccione cómo desea registrar este trabajo</small></p>
          </div>
        </div>

        <div class="row mt-3">
          <div class="col-md-12">
            <div class="form-group">
              {% for choice in form.tipo_registro %}
                <div class="form-check mb-2">
                  {{ choice.tag }}
                  <label class="form-check-label" for="{{ choice.id_for_label }}">
                    <strong>{{ choice.choice_label }}</strong>
                    {% if choice.data.value == 'HORAS_EXTRA' %}
                      <br><small class="text-muted">El sistema calculará automáticamente el monto según la hora de inicio y fin (recargos 25%, 50% o 100%)</small>
                    {% else %}
                      <br><small class="text-muted">Use esto para pagos fijos por día (limpieza, ayudantes, etc.). Especifique el monto total acordado.</small>
                    {% endif %}
                  </label>
                </div>
              {% endfor %}
              {% if form.tipo_registro.errors %}<small class="text-danger">{{ form.tipo_registro.errors }}</small>{% endif %}
            </div>
          </div>
        </div>

        <div class="row mt-3" id="monto_dia_container" style="display: none;">
          <div class="col-md-6">
            <div class="alert alert-success" role="alert">
              <i class="fas fa-hand-holding-usd"></i>
              <strong>Pago por Día:</strong> Ingrese el monto total que se pagará por el día de trabajo.
            </div>
            <div class="form-group">
              {{ form.monto_pago_dia.label_tag }}
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text">$</span>
                </div>
                {{ form.monto_pago_dia }}
              </div>
              {% if form.monto_pago_dia.errors %}<small class="text-danger">{{ form.monto_pago_dia.errors }}</small>{% endif %}
              <small class="form-text text-muted">{{ form.monto_pago_dia.help_text }}</small>
            </div>
          </div>
        </div>

        <script>
          // Mostrar/ocultar campo de monto según selección
          document.addEventListener('DOMContentLoaded', function() {
            const radioHorasExtra = document.querySelector('input[value="HORAS_EXTRA"]');
            const radioPagoDia = document.querySelector('input[value="PAGO_DIA"]');
            const montoDiaContainer = document.getElementById('monto_dia_container');
            const horasContainer = document.querySelectorAll('.col-md-4'); // Contenedores de hora_inicio y hora_fin
            
            function toggleFields() {
              if (radioPagoDia && radioPagoDia.checked) {
                montoDiaContainer.style.display = 'block';
                // Marcar campos de hora como opcionales visualmente
                horasContainer.forEach(container => {
                  const label = container.querySelector('label');
                  if (label && (label.textContent.includes('Inicio') || label.textContent.includes('Fin'))) {
                    container.style.opacity = '0.6';
                  }
                });
              } else {
                montoDiaContainer.style.display = 'none';
                horasContainer.forEach(container => {
                  container.style.opacity = '1';
                });
              }
            }
            
            if (radioHorasExtra) radioHorasExtra.addEventListener('change', toggleFields);
            if (radioPagoDia) radioPagoDia.addEventListener('change', toggleFields);
            
            toggleFields(); // Llamar al cargar la página
          });
        </script>

        <div class="mt-3">
          {% if object %}
            <button class="btn btn-success" type="submit">
              <i class="fas fa-save"></i> Actualizar Horas Extra
            </button>
          {% else %}
            <button class="btn btn-primary" type="submit">
              <i class="fas fa-save"></i> Registrar Horas Extra
            </button>
          {% endif %}
          <a href="{% url 'personal:horas-extra-list' %}" class="btn btn-secondary">
            <i class="fas fa-times"></i> Cancelar
          </a>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
