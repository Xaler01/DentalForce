{% extends "base/base.html" %}

{% block title %}Editar Procedimientos - Evolución {% endblock %}

{% block page_content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="h2">{{ titulo }}</h1>
            <p class="text-muted">Evolución del {{ evolucion.fecha_consulta|date:"d/m/Y" }}</p>
        </div>
        <div class="col-md-4 text-right">
            <a href="{% url 'evolucion:detalle' evolucion.pk %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
        </div>
    </div>
    
    <!-- Form -->
    <div class="card">
        <div class="card-header">
            <i class="fas fa-tools"></i> Procedimientos en Evolución
        </div>
        <div class="card-body">
            <form method="POST">
                {% csrf_token %}
                
                {{ formset.management_form }}
                
                <div id="select2-dropdown-container"></div>
                
                <div class="table-responsive">
                    <table class="table table-bordered" id="procedimientos-table">
                        <thead class="bg-light">
                            <tr>
                                <th>Procedimiento</th>
                                <th>Cantidad</th>
                                <th>Observaciones</th>
                                <th class="text-center">Eliminar</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for form in formset %}
                            <tr class="formset-row">
                                {% for hidden in form.hidden_fields %}
                                {{ hidden }}
                                {% endfor %}
                                <td class="procedimiento-cell">
                                    {{ form.procedimiento }}
                                    {% if form.procedimiento.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.procedimiento.errors }}
                                    </div>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ form.cantidad }}
                                    {% if form.cantidad.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.cantidad.errors }}
                                    </div>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ form.observaciones }}
                                </td>
                                <td class="text-center">
                                    {{ form.DELETE }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="form-group mt-3 d-flex align-items-center">
                    <button type="button" class="btn btn-outline-primary mr-3" id="add-procedimiento">
                        <i class="fas fa-plus"></i> Agregar procedimiento
                    </button>
                    <button type="submit" class="btn btn-primary mr-2">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                    <a href="{% url 'evolucion:detalle' evolucion.pk %}" class="btn btn-secondary">
                        Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock page_content %}

{% block js_page %}
<script>
$(document).ready(function() {
    // Initialize Select2 con búsqueda habilitada
    const select2Opts = { 
        theme: "bootstrap",
        width: '100%',
        placeholder: 'Buscar procedimiento...',
        allowClear: false,
        dropdownAutoWidth: false,
        dropdownParent: $('#select2-dropdown-container'),
        language: {
            noResults: function() {
                return "No se encontraron resultados";
            },
            searching: function() {
                return "Buscando...";
            }
        }
    };
    $('.select2').select2(select2Opts);

    const prefix = '{{ formset.prefix }}';
    let totalForms = parseInt($('#id_' + prefix + '-TOTAL_FORMS').val(), 10) || 0;

    function getEmptyFormRow() {
        const form = `{{ formset.empty_form|escapejs }}`;
        const newForm = form.replace(/__prefix__/g, totalForms);
        return newForm;
    }

    $('#add-procedimiento').on('click', function(e) {
        e.preventDefault();
        
        // Get the empty form HTML
        const emptyFormRow = getEmptyFormRow();
        
        // Create a temporary div to parse HTML
        const $tempDiv = $('<div>').html(emptyFormRow);
        
        // Extract only the tbody row
        const $newRow = $tempDiv.find('tr').first();
        
        if ($newRow.length === 0) {
            // Fallback: manually create the row structure
            const selectId = `id_${prefix}-${totalForms}-procedimiento`;
            const cantidadId = `id_${prefix}-${totalForms}-cantidad`;
            const obsId = `id_${prefix}-${totalForms}-observaciones`;
            const deleteId = `id_${prefix}-${totalForms}-DELETE`;
            
            const $newRow = $(`
                <tr class="formset-row">
                    <input type="hidden" id="id_${prefix}-${totalForms}-id" name="${prefix}-${totalForms}-id">
                    <input type="hidden" id="id_${prefix}-${totalForms}-evolucion" name="${prefix}-${totalForms}-evolucion">
                    <td class="procedimiento-cell">
                        <select id="${selectId}" name="${prefix}-${totalForms}-procedimiento" class="form-control select2"></select>
                    </td>
                    <td>
                        <input type="number" id="${cantidadId}" name="${prefix}-${totalForms}-cantidad" min="1" value="1" class="form-control">
                    </td>
                    <td>
                        <textarea id="${obsId}" name="${prefix}-${totalForms}-observaciones" class="form-control" rows="2"></textarea>
                    </td>
                    <td class="text-center">
                        <input type="checkbox" id="${deleteId}" name="${prefix}-${totalForms}-DELETE">
                    </td>
                </tr>
            `);
        }
        
        $('#procedimientos-table tbody').append($newRow);
        
        // Init select2 for the newly added select
        const selectId = `id_${prefix}-${totalForms}-procedimiento`;
        const $newSelect = $(`#${selectId}`);
        
        if ($newSelect.length > 0) {
            // Clear any existing Select2 instance
            if ($newSelect.data('select2')) {
                $newSelect.select2('destroy');
            }
            $newSelect.select2(select2Opts);
        }
        
        totalForms += 1;
        $('#id_' + prefix + '-TOTAL_FORMS').val(totalForms);
    });
});
</script>
<style>
/* Contenedor para dropdown de Select2 fuera del overflow */
#select2-dropdown-container {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 9999;
    pointer-events: none;
}

#select2-dropdown-container .select2-dropdown {
    position: absolute !important;
    pointer-events: auto;
}

/* Tabla scrollable con altura máxima */
.table-responsive {
    max-height: 500px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
}

/* Fijar cabecera de tabla */
#procedimientos-table thead th {
    position: sticky;
    top: 0;
    background-color: #f8f9fa;
    z-index: 10;
    box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
}

/* Mejorar apariencia del Select2 */
.procedimiento-cell .select2-container { 
    width: 100% !important; 
}

.procedimiento-cell .select2-selection--single {
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
    min-height: calc(1.5em + 0.75rem + 2px);
    display: flex;
    align-items: center;
    background: #fff;
}

.procedimiento-cell .select2-selection__rendered { 
    line-height: 1.5rem;
    padding-left: 0.5rem;
}

.procedimiento-cell .select2-selection__arrow { 
    height: 100%; 
}

/* Hacer el dropdown más amigable */
.select2-dropdown {
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
}

.select2-search--dropdown .select2-search__field {
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
    padding: 0.375rem 0.75rem;
}

/* Limitar altura del dropdown */
.select2-results__options {
    max-height: 300px;
}

/* Z-index alto para dropdown */
.select2-container--open {
    z-index: 9999 !important;
}

.select2-dropdown {
    z-index: 9999 !important;
}

/* Mejorar alineación de tabla */
#procedimientos-table th,
#procedimientos-table td {
    vertical-align: middle;
}

#procedimientos-table th:nth-child(1),
#procedimientos-table td:nth-child(1) {
    width: 40%;
}

#procedimientos-table th:nth-child(2),
#procedimientos-table td:nth-child(2) {
    width: 10%;
    text-align: center;
}

#procedimientos-table th:nth-child(3),
#procedimientos-table td:nth-child(3) {
    width: 40%;
}

#procedimientos-table th:nth-child(4),
#procedimientos-table td:nth-child(4) {
    width: 10%;
    text-align: center;
}
</style>
{% endblock js_page %}
