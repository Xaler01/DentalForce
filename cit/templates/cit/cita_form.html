{% extends 'base/base.html' %}
{% load static %}

{% block page_content %}
<div class="container-fluid">
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-calendar-plus"></i> 
            {% if form.instance.pk %}Editar Cita #{{ form.instance.pk }}{% else %}Nueva Cita{% endif %}
        </h1>
        <a href="{% url 'cit:cita-list' %}" class="btn btn-sm btn-secondary">
            <i class="fas fa-arrow-left"></i> Cancelar
        </a>
    </div>

    <div class="row">
        <div class="col-lg-10 mx-auto">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-edit"></i> Formulario de Cita
                    </h6>
                </div>
                <div class="card-body">
                    <form method="post" id="citaForm">
                        {% csrf_token %}
                        
                        <!-- Errores generales del formulario -->
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger" role="alert">
                            {{ form.non_field_errors }}
                        </div>
                        {% endif %}

                        <!-- Secci√≥n 1: Paciente -->
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-user-injured"></i> Informaci√≥n del Paciente
                        </h5>
                        
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <!-- Card para b√∫squeda de paciente -->
                                <div class="card border-left-primary shadow-sm">
                                    <div class="card-body">
                                        <!-- Tabs para alternar entre b√∫squedas -->
                                        <ul class="nav nav-tabs mb-3" id="busquedaTabs" role="tablist">
                                            <li class="nav-item">
                                                <a class="nav-link active" id="apellido-tab" data-toggle="tab" href="#busqueda-apellido" role="tab">
                                                    <i class="fas fa-signature"></i> Buscar por Apellido
                                                </a>
                                            </li>
                                        </ul>

                                        <!-- Contenido de tabs -->
                                        <div class="tab-content" id="busquedaTabContent">
                                            <!-- Tab: B√∫squeda por Apellido -->
                                            <div class="tab-pane fade show active" id="busqueda-apellido" role="tabpanel">
                                                <div class="form-group mb-0">
                                                    <label for="{{ form.paciente.id_for_label }}" class="font-weight-bold">
                                                        Paciente <span class="text-danger">*</span>
                                                    </label>
                                                    {{ form.paciente }}
                                                    {% if form.paciente.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.paciente.errors }}
                                                    </div>
                                                    {% endif %}
                                                    <small class="form-text text-muted">
                                                        <i class="fas fa-search"></i> Escribe al menos 2 letras del apellido del paciente
                                                    </small>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Mensaje de paciente seleccionado -->
                                        <div id="paciente_seleccionado" class="alert alert-success mt-3" style="display: none;">
                                            <i class="fas fa-check-circle"></i> <strong>Paciente seleccionado:</strong> <span id="paciente_nombre"></span>
                                        </div>

                                        <!-- Alertas especiales de VIP y condiciones cr√≠ticas -->
                                        <div id="paciente_alertas" style="display: none; margin-top: 12px;"></div>

                                        <!-- Bot√≥n crear paciente -->
                                        <div class="mt-3 pt-3 border-top">
                                            <a href="{% url 'pacientes:paciente-create' %}" target="_blank" class="btn btn-success">
                                                <i class="fas fa-user-plus"></i> Crear nuevo paciente
                                            </a>
                                            <small class="text-muted ml-2">
                                                <i class="fas fa-external-link-alt"></i> Se abrir√° en nueva pesta√±a
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <hr>

                        <!-- Secci√≥n 2: Dentista y Especialidad -->
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-user-md"></i> Dentista y Especialidad
                        </h5>
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.dentista.id_for_label }}">
                                        {{ form.dentista.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.dentista }}
                                    <div id="dentista-disponibilidad" class="mt-2" style="display:none;">
                                        <small class="text-muted">
                                            <i class="fas fa-spinner fa-spin"></i> Verificando disponibilidad...
                                        </small>
                                    </div>
                                    {% if form.dentista.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.dentista.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.especialidad.id_for_label }}">
                                        {{ form.especialidad.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.especialidad }}
                                    {% if form.especialidad.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.especialidad.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <hr>

                        <!-- Secci√≥n 3: Fecha, Hora y Duraci√≥n -->
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-calendar-alt"></i> Fecha, Hora y Duraci√≥n
                        </h5>
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.fecha_hora.id_for_label }}">
                                        {{ form.fecha_hora.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.fecha_hora }}
                                    {% if form.fecha_hora.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.fecha_hora.errors }}
                                    </div>
                                    {% endif %}
                                    {% if form.fecha_hora.help_text %}
                                    <small class="form-text text-muted">{{ form.fecha_hora.help_text }}</small>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.duracion.id_for_label }}">
                                        {{ form.duracion.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.duracion }}
                                    {% if form.duracion.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.duracion.errors }}
                                    </div>
                                    {% endif %}
                                    {% if form.duracion.help_text %}
                                    <small class="form-text text-muted">{{ form.duracion.help_text }}</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <hr>

                        <!-- Secci√≥n 4: Cub√≠culo -->
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-door-open"></i> Cub√≠culo
                        </h5>
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="{{ form.cubiculo.id_for_label }}">
                                        {{ form.cubiculo.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.cubiculo }}
                                    <div id="cubiculo-disponibilidad" class="mt-2" style="display:none;">
                                        <small class="text-muted">
                                            <i class="fas fa-spinner fa-spin"></i> Verificando disponibilidad...
                                        </small>
                                    </div>
                                    {% if form.cubiculo.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.cubiculo.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <hr>

                        <!-- Secci√≥n 5: Estado y Observaciones -->
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-sticky-note"></i> Estado y Observaciones
                        </h5>
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.estado.id_for_label }}">
                                        {{ form.estado.label }}
                                    </label>
                                    {{ form.estado }}
                                    {% if form.estado.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.estado.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="form-group">
                                    <label for="{{ form.observaciones.id_for_label }}">
                                        {{ form.observaciones.label }}
                                    </label>
                                    {{ form.observaciones }}
                                    {% if form.observaciones.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.observaciones.errors }}
                                    </div>
                                    {% endif %}
                                    {% if form.observaciones.help_text %}
                                    <small class="form-text text-muted">{{ form.observaciones.help_text }}</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <hr>

                        <!-- Botones -->
                        <div class="row">
                            <div class="col-md-12 text-right">
                                <a href="{% url 'cit:cita-list' %}" class="btn btn-secondary">
                                    <i class="fas fa-times"></i> Cancelar
                                </a>
                                <button type="submit" class="btn btn-primary" id="btnSubmit">
                                    <i class="fas fa-save"></i> 
                                    {% if form.instance.pk %}Actualizar Cita{% else %}Crear Cita{% endif %}
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Inicializar Select2 para campos normales (excluir paciente)
    $('.select2').not('#id_paciente').select2({
        theme: 'bootstrap4',
        width: '100%',
        placeholder: 'Seleccione una opci√≥n'
    });

    // Inicializar Select2 simple para paciente (b√∫squeda por apellido)
    var $pacienteSelect = $('#id_paciente');
    
    // Agregar required din√°micamente (as√≠ no interfiere con las validaciones del navegador cuando est√° oculto)
    $pacienteSelect.prop('required', true);
    
    $pacienteSelect.select2({
        theme: 'bootstrap4',
        width: '100%',
        placeholder: 'Escribe el apellido del paciente...',
        allowClear: true,
        minimumInputLength: 2,
        
        ajax: {
            url: '{% url "cit:ajax-buscar-pacientes" %}',
            type: 'GET',
            dataType: 'json',
            delay: 300,
            
            data: function(params) {
                return {
                    q: params.term || '',
                    page: params.page || 1
                };
            },
            
            processResults: function(data, params) {
                params.page = params.page || 1;
                return {
                    results: data.results,
                    pagination: {
                        more: (data.pagination && data.pagination.more) || false
                    }
                };
            }
        },
        
        templateResult: function(data) {
            if (data.loading) return 'Buscando...';
            if (!data.id) return data.text || '';
            
            var $result = $('<div style="padding: 5px 0;"></div>');
            var $nombre = $('<div style="font-weight: 500;">' + data.text + '</div>');
            $result.append($nombre);
            
            if (data.cedula) {
                var $cedula = $('<div style="font-size: 0.85em; color: #666;">C√©dula: ' + data.cedula + '</div>');
                $result.append($cedula);
            }
            
            return $result;
        },
        
        templateSelection: function(data) {
            return data.text || 'Seleccione un paciente';
        },
        
        language: {
            inputTooShort: function() {
                return 'Escribe al menos 2 caracteres del apellido';
            },
            noResults: function() {
                return 'No se encontraron pacientes';
            },
            searching: function() {
                return 'Buscando...';
            }
        }
    });

    
    // Mostrar mensaje cuando se selecciona paciente por apellido
    $pacienteSelect.on('select2:select', function(e) {
        var pacienteText = e.params.data.text;
        var es_vip = e.params.data.es_vip;
        var categoria_vip = e.params.data.categoria_vip;
        var tiene_enfermedades_criticas = e.params.data.tiene_enfermedades_criticas;
        var nivel_alerta = e.params.data.nivel_alerta;
        
        $('#paciente_nombre').text(pacienteText);
        $('#paciente_seleccionado').fadeIn();
        
        // Mostrar alertas especiales
        mostrarAlertasPaciente(es_vip, categoria_vip, tiene_enfermedades_criticas, nivel_alerta);
    });
    
    function mostrarAlertasPaciente(es_vip, categoria_vip, tiene_enfermedades_criticas, nivel_alerta) {
        var html = '';
        
        console.log('mostrarAlertasPaciente() - es_vip:', es_vip, 'categoria_vip:', categoria_vip, 'enfermedades_criticas:', tiene_enfermedades_criticas, 'nivel:', nivel_alerta);
        
        // Alerta de ENFERMEDADES CR√çTICAS (m√°s importante, va primero)
        if (tiene_enfermedades_criticas === true || tiene_enfermedades_criticas === 'true' || tiene_enfermedades_criticas === 'True') {
            html += '<div class="alert alert-danger mb-2">' +
                    '<i class="fas fa-exclamation-triangle"></i> <strong>‚ö†Ô∏è PACIENTE CON ENFERMEDADES CR√çTICAS</strong><br>' +
                    '<small>Revisar historial m√©dico antes de proceder con el tratamiento</small>' +
                    '</div>';
        } else if (nivel_alerta === 'ALTO' || nivel_alerta === 'alto') {
            html += '<div class="alert alert-warning mb-2">' +
                    '<i class="fas fa-exclamation-circle"></i> <strong>‚ö†Ô∏è PACIENTE CON CONDICIONES DE ALTO RIESGO</strong><br>' +
                    '<small>Revisar condiciones m√©dicas preexistentes</small>' +
                    '</div>';
        } else if (nivel_alerta === 'MEDIO' || nivel_alerta === 'medio') {
            html += '<div class="alert alert-info mb-2">' +
                    '<i class="fas fa-info-circle"></i> <strong>‚ÑπÔ∏è PACIENTE CON CONDICIONES M√âDICAS</strong><br>' +
                    '<small>Tomar precauciones seg√∫n historial</small>' +
                    '</div>';
        }
        
        // Alerta de VIP
        if (es_vip === true || es_vip === 'true' || es_vip === 'True') {
            if (categoria_vip === 'PLATINUM' || categoria_vip === 'platinum') {
                html += '<div class="alert alert-danger mb-2">' +
                        '<i class="fas fa-star"></i> <strong>‚≠ê PACIENTE VIP PLATINUM</strong> - Dar trato prioritario' +
                        '</div>';
            } else if (categoria_vip === 'PREMIUM' || categoria_vip === 'premium') {
                html += '<div class="alert alert-warning mb-2">' +
                        '<i class="fas fa-gem"></i> <strong>üíé PACIENTE VIP PREMIUM</strong> - Atenci√≥n especial' +
                        '</div>';
            } else if (categoria_vip === 'STANDARD' || categoria_vip === 'standard') {
                html += '<div class="alert alert-info mb-2">' +
                        '<i class="fas fa-medal"></i> <strong>üèÖ PACIENTE VIP STANDARD</strong>' +
                        '</div>';
            } else {
                html += '<div class="alert alert-primary mb-2">' +
                        '<i class="fas fa-crown"></i> <strong>üëë PACIENTE VIP</strong>' +
                        '</div>';
            }
            
            console.log('Mostrando alerta VIP');
        }
        
        if (html) {
            $('#paciente_alertas').html(html).fadeIn();
            console.log('Alertas mostradas');
        } else {
            $('#paciente_alertas').fadeOut();
            console.log('Sin alertas para este paciente');
        }
    }
        $pacienteSelect.on('select2:unselect', function(e) {
        $('#paciente_seleccionado').fadeOut();
    });

    // Variables para control de validaci√≥n
    let dentistaDisponible = true;
    let cubiculoDisponible = true;
    let citaId = {% if form.instance.pk %}{{ form.instance.pk }}{% else %}null{% endif %};

    // Funci√≥n para verificar disponibilidad del dentista
    function checkDentistaDisponibilidad() {
        let dentistaId = $('#id_dentista').val();
        let fechaHora = $('#id_fecha_hora').val();
        let duracion = $('#id_duracion').val();

        if (!dentistaId || !fechaHora || !duracion) {
            return;
        }

        $('#dentista-disponibilidad').show().html(
            '<small class="text-muted"><i class="fas fa-spinner fa-spin"></i> Verificando disponibilidad del dentista...</small>'
        );

        $.ajax({
            url: '{% url "cit:ajax-dentista-disponibilidad" %}',
            data: {
                'dentista_id': dentistaId,
                'fecha_hora': fechaHora,
                'duracion': duracion,
                'cita_id': citaId
            },
            success: function(data) {
                if (data.disponible) {
                    dentistaDisponible = true;
                    $('#dentista-disponibilidad').html(
                        '<small class="text-success"><i class="fas fa-check-circle"></i> ' + data.mensaje + '</small>'
                    );
                } else {
                    dentistaDisponible = false;
                    $('#dentista-disponibilidad').html(
                        '<small class="text-danger"><i class="fas fa-times-circle"></i> ' + data.mensaje + '</small>'
                    );
                }
                updateSubmitButton();
            },
            error: function() {
                $('#dentista-disponibilidad').html(
                    '<small class="text-warning"><i class="fas fa-exclamation-triangle"></i> Error al verificar disponibilidad</small>'
                );
            }
        });
    }

    // Funci√≥n para verificar disponibilidad del cub√≠culo
    function checkCubiculoDisponibilidad() {
        let cubiculoId = $('#id_cubiculo').val();
        let fechaHora = $('#id_fecha_hora').val();
        let duracion = $('#id_duracion').val();

        if (!cubiculoId || !fechaHora || !duracion) {
            return;
        }

        $('#cubiculo-disponibilidad').show().html(
            '<small class="text-muted"><i class="fas fa-spinner fa-spin"></i> Verificando disponibilidad del cub√≠culo...</small>'
        );

        $.ajax({
            url: '{% url "cit:ajax-cubiculo-disponibilidad" %}',
            data: {
                'cubiculo_id': cubiculoId,
                'fecha_hora': fechaHora,
                'duracion': duracion,
                'cita_id': citaId
            },
            success: function(data) {
                if (data.disponible) {
                    cubiculoDisponible = true;
                    $('#cubiculo-disponibilidad').html(
                        '<small class="text-success"><i class="fas fa-check-circle"></i> ' + data.mensaje + '</small>'
                    );
                } else {
                    cubiculoDisponible = false;
                    $('#cubiculo-disponibilidad').html(
                        '<small class="text-danger"><i class="fas fa-times-circle"></i> ' + data.mensaje + '</small>'
                    );
                }
                updateSubmitButton();
            },
            error: function() {
                $('#cubiculo-disponibilidad').html(
                    '<small class="text-warning"><i class="fas fa-exclamation-triangle"></i> Error al verificar disponibilidad</small>'
                );
            }
        });
    }

    // Funci√≥n para cargar especialidades del dentista
    function loadDentistaEspecialidades() {
        let dentistaId = $('#id_dentista').val();
        
        if (!dentistaId) {
            // Si no hay dentista seleccionado, restaurar todas las especialidades originales
            return;
        }

        // Mostrar estado de carga en el select
        let $especialidadSelect = $('#id_especialidad');
        let firstOption = $especialidadSelect.find('option:first');
        $especialidadSelect.empty().append(firstOption);
        firstOption.text('Cargando especialidades...');
        $especialidadSelect.trigger('change.select2');

        $.ajax({
            url: '{% url "cit:ajax-dentista-especialidades" dentista_id=0 %}'.replace('/0/', '/' + dentistaId + '/'),
            success: function(data) {
                console.log('Especialidades cargadas para dentista', dentistaId, data);
                let currentValue = $especialidadSelect.val();

                // Reinicializar opciones
                $especialidadSelect.empty().append(firstOption);
                firstOption.text('---------');

                if (data.success && data.especialidades.length > 0) {
                    // Agregar especialidades del dentista
                    $.each(data.especialidades, function(index, esp) {
                        $especialidadSelect.append(
                            $('<option></option>')
                                .attr('value', esp.id)
                                .text(esp.nombre)
                        );
                    });
                    
                    // Mantener selecci√≥n v√°lida o autoseleccionar
                    if (currentValue && data.especialidades.some(e => e.id == currentValue)) {
                        $especialidadSelect.val(currentValue);
                        let especialidad = data.especialidades.find(e => e.id == currentValue);
                        if (especialidad && especialidad.duracion_default) {
                            $('#id_duracion').val(especialidad.duracion_default);
                        }
                    } else if (data.especialidades.length === 1) {
                        $especialidadSelect.val(data.especialidades[0].id);
                        $('#id_duracion').val(data.especialidades[0].duracion_default);
                    } else {
                        $especialidadSelect.val('');
                    }
                } else {
                    // Si no tiene especialidades, avisar y dejar vac√≠o
                    alert('Este dentista no tiene especialidades asignadas');
                    $especialidadSelect.val('');
                }

                // Actualizar Select2
                $especialidadSelect.trigger('change.select2');
                $especialidadSelect.trigger('change');
            },
            error: function() {
                console.error('Error al cargar especialidades del dentista');
            }
        });
    }

    // Funci√≥n para cargar dentistas de la especialidad
    function loadEspecialidadDentistas() {
        let especialidadId = $('#id_especialidad').val();
        
        if (!especialidadId) {
            // Si no hay especialidad seleccionada, no filtrar dentistas
            return;
        }

        $.ajax({
            url: '{% url "cit:ajax-especialidad-dentistas" especialidad_id=0 %}'.replace('/0/', '/' + especialidadId + '/'),
            success: function(data) {
                if (data.success && data.dentistas.length > 0) {
                    // Actualizar opciones de dentista
                    let $dentistaSelect = $('#id_dentista');
                    let currentValue = $dentistaSelect.val();
                    
                    // Mantener la primera opci√≥n (vac√≠a o "Seleccione")
                    let firstOption = $dentistaSelect.find('option:first');
                    $dentistaSelect.empty().append(firstOption);
                    
                    // Agregar dentistas de la especialidad
                    $.each(data.dentistas, function(index, dentista) {
                        $dentistaSelect.append(
                            $('<option></option>')
                                .attr('value', dentista.id)
                                .text(dentista.nombre)
                        );
                    });
                    
                    // Si hab√≠a un dentista seleccionado y est√° en la lista, mantenerlo
                    if (currentValue && data.dentistas.some(d => d.id == currentValue)) {
                        $dentistaSelect.val(currentValue);
                    }
                    // Si solo hay un dentista, seleccionarlo autom√°ticamente
                    else if (data.dentistas.length === 1) {
                        $dentistaSelect.val(data.dentistas[0].id);
                        $dentistaSelect.trigger('change');
                    } else {
                        // Limpiar selecci√≥n si el dentista anterior no es v√°lido
                        $dentistaSelect.val('');
                    }
                } else {
                    // Si no hay dentistas, mostrar mensaje
                    alert('No hay dentistas disponibles para esta especialidad');
                    $('#id_especialidad').val('');
                }
            },
            error: function() {
                alert('Error al cargar dentistas de la especialidad');
            }
        });
    }

    // Funci√≥n para habilitar/deshabilitar bot√≥n de submit
    function updateSubmitButton() {
        if (dentistaDisponible && cubiculoDisponible) {
            $('#btnSubmit').prop('disabled', false).removeClass('btn-secondary').addClass('btn-primary');
        } else {
            $('#btnSubmit').prop('disabled', true).removeClass('btn-primary').addClass('btn-secondary');
        }
    }

    // Event listeners
    function onDentistaChange() {
        loadDentistaEspecialidades();
        checkDentistaDisponibilidad();
    }

    $('#id_dentista').on('change', onDentistaChange);
    $('#id_dentista').on('select2:select', onDentistaChange);

    $('#id_especialidad').on('change', function() {
        loadEspecialidadDentistas();
    });

    $('#id_fecha_hora, #id_duracion').on('change', function() {
        checkDentistaDisponibilidad();
        checkCubiculoDisponibilidad();
    });

    $('#id_cubiculo').on('change', function() {
        checkCubiculoDisponibilidad();
    });

    // Validaci√≥n inicial si estamos editando
    {% if form.instance.pk %}
    checkDentistaDisponibilidad();
    checkCubiculoDisponibilidad();
    loadDentistaEspecialidades();  // Cargar especialidades del dentista si existe
    {% else %}
    // Tambi√©n ejecutar si estamos creando y hay un dentista preseleccionado
    if ($('#id_dentista').val()) {
        loadDentistaEspecialidades();
    }
    {% endif %}
});
</script>
{% endblock %}
