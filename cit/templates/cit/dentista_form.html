{% extends 'base/base.html' %}
{% load static %}

{% block page_content %}
<div class="container-fluid">
    <!-- Encabezado -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-user-md fa-fw text-primary"></i>
                {% if form.instance.pk %}
                    Editar Dentista
                {% else %}
                    Nuevo Dentista
                {% endif %}
            </h1>
            {% if form.instance.pk and form.instance.user %}
                <p class="text-muted mb-0 mt-1" style="font-size: 0.9rem; margin-left: 2.2rem;">
                    <i class="fas fa-user-circle"></i>
                    {{ form.instance.user.get_full_name }}
                    {% if form.instance.cedula %}
                        <span class="text-secondary">| CI: {{ form.instance.cedula }}</span>
                    {% endif %}
                </p>
            {% endif %}
        </div>
        <a href="{% url 'cit:dentista-list' %}" class="btn btn-secondary btn-icon-split">
            <span class="icon text-white-50">
                <i class="fas fa-arrow-left"></i>
            </span>
            <span class="text">Volver al Listado</span>
        </a>
    </div>

    <!-- Formulario -->
    <form method="post" enctype="multipart/form-data" id="dentista-form">
        {% csrf_token %}
        
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <ul class="nav nav-tabs card-header-tabs" id="dentistaTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link {% if active_tab == 'datos' or not active_tab %}active{% endif %}" 
                           id="datos-tab" 
                           data-toggle="tab" 
                           href="#datos" 
                           role="tab">
                            <i class="fas fa-user"></i> Datos Personales
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if active_tab == 'horarios' %}active{% endif %}" 
                           id="horarios-tab" 
                           data-toggle="tab" 
                           href="#horarios" 
                           role="tab">
                            <i class="fas fa-clock"></i> Horarios de Atención
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if active_tab == 'excepciones' %}active{% endif %}" 
                           id="excepciones-tab" 
                           data-toggle="tab" 
                           href="#excepciones" 
                           role="tab">
                            <i class="fas fa-calendar-times"></i> Excepciones
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if active_tab == 'comisiones' %}active{% endif %}" 
                           id="comisiones-tab" 
                           data-toggle="tab" 
                           href="#comisiones" 
                           role="tab">
                            <i class="fas fa-dollar-sign"></i> Comisiones
                        </a>
                    </li>
                </ul>
            </div>
            
            <div class="card-body">
                <div class="tab-content" id="dentistaTabContent">
                    
                    <!-- TAB 1: Datos Personales -->
                    <div class="tab-pane fade {% if active_tab == 'datos' or not active_tab %}show active{% endif %}" 
                         id="datos" 
                         role="tabpanel">
                        
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-user-circle"></i> Información del Usuario
                        </h5>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.first_name.id_for_label }}" class="font-weight-bold">
                                        {{ form.first_name.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.first_name }}
                                    {% if form.first_name.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.first_name.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.last_name.id_for_label }}" class="font-weight-bold">
                                        {{ form.last_name.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.last_name }}
                                    {% if form.last_name.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.last_name.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.username.id_for_label }}" class="font-weight-bold">
                                        {{ form.username.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.username }}
                                    <small class="form-text text-muted">{{ form.username.help_text }}</small>
                                    {% if form.username.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.username.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.email.id_for_label }}" class="font-weight-bold">
                                        {{ form.email.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.email }}
                                    {% if form.email.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.email.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.password.id_for_label }}" class="font-weight-bold">
                                        {{ form.password.label }}
                                        {% if not form.instance.pk %}<span class="text-danger">*</span>{% endif %}
                                    </label>
                                    {{ form.password }}
                                    <small class="form-text text-muted">{{ form.password.help_text }}</small>
                                    {% if form.password.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.password.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <h5 class="text-primary mb-3">
                            <i class="fas fa-id-card"></i> Información Profesional
                        </h5>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.cedula_profesional.id_for_label }}" class="font-weight-bold">
                                        {{ form.cedula_profesional.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.cedula_profesional }}
                                    {% if form.cedula_profesional.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.cedula_profesional.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.numero_licencia.id_for_label }}" class="font-weight-bold">
                                        {{ form.numero_licencia.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.numero_licencia }}
                                    {% if form.numero_licencia.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.numero_licencia.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.especialidades.id_for_label }}" class="font-weight-bold">
                                        {{ form.especialidades.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.especialidades }}
                                    <small class="form-text text-muted">Selección múltiple</small>
                                    {% if form.especialidades.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.especialidades.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.sucursales.id_for_label }}" class="font-weight-bold">
                                        {{ form.sucursales.label }}
                                    </label>
                                    {{ form.sucursales }}
                                    <small class="form-text text-muted">Selección múltiple</small>
                                    {% if form.sucursales.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.sucursales.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.sucursal_principal.id_for_label }}" class="font-weight-bold">
                                        {{ form.sucursal_principal.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.sucursal_principal }}
                                    <small class="form-text text-muted">Sucursal donde trabaja principalmente</small>
                                    {% if form.sucursal_principal.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.sucursal_principal.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.telefono_movil.id_for_label }}" class="font-weight-bold">
                                        {{ form.telefono_movil.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.telefono_movil }}
                                    {% if form.telefono_movil.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.telefono_movil.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.fecha_contratacion.id_for_label }}" class="font-weight-bold">
                                        {{ form.fecha_contratacion.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.fecha_contratacion }}
                                    {% if form.fecha_contratacion.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.fecha_contratacion.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="{{ form.biografia.id_for_label }}" class="font-weight-bold">
                                        {{ form.biografia.label }}
                                    </label>
                                    {{ form.biografia }}
                                    {% if form.biografia.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.biografia.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.foto.id_for_label }}" class="font-weight-bold">
                                        {{ form.foto.label }}
                                    </label>
                                    {{ form.foto }}
                                    {% if form.instance.foto %}
                                        <div class="mt-2">
                                            <img src="{{ form.instance.foto.url }}" 
                                                 alt="Foto actual" 
                                                 class="img-thumbnail"
                                                 style="max-width: 150px;">
                                        </div>
                                    {% endif %}
                                    {% if form.foto.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.foto.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="font-weight-bold">{{ form.estado.label }}</label>
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" 
                                               class="custom-control-input" 
                                               id="{{ form.estado.id_for_label }}" 
                                               name="estado" 
                                               value="True"
                                               {% if form.instance.pk %}
                                                   {% if form.instance.estado %}checked{% endif %}
                                               {% else %}
                                                   checked
                                               {% endif %}>
                                        <label class="custom-control-label font-weight-bold" for="{{ form.estado.id_for_label }}">
                                            Dentista activo
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- TAB 2: Horarios de Atención -->
                    <div class="tab-pane fade {% if active_tab == 'horarios' %}show active{% endif %}" 
                         id="horarios" 
                         role="tabpanel">
                        
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-clock"></i> Configuración de Horarios Semanales
                        </h5>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Instrucciones:</strong> Configure los horarios de atención del dentista para cada día de la semana. 
                            Puede tener múltiples horarios por día y por sucursal (ej: Lunes mañana en Sucursal Norte, Lunes tarde en Sucursal Sur).
                        </div>

                        {{ disponibilidad_formset.management_form }}
                        
                        <div id="disponibilidad-formset">
                            {% for form in disponibilidad_formset %}
                                <div class="formset-row card mb-3 {% if form.instance.pk and not form.instance.activo %}bg-light{% endif %}">
                                    <div class="card-body">
                                        <div class="row align-items-center">
                                            <div class="col-md-2">
                                                <div class="form-group mb-0">
                                                    <label class="font-weight-bold">Sucursal</label>
                                                    {{ form.sucursal }}
                                                    {% if form.sucursal.errors %}
                                                        <div class="invalid-feedback d-block">
                                                            {{ form.sucursal.errors.0 }}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group mb-0">
                                                    <label class="font-weight-bold">Día</label>
                                                    {{ form.dia_semana }}
                                                    {% if form.dia_semana.errors %}
                                                        <div class="invalid-feedback d-block">
                                                            {{ form.dia_semana.errors.0 }}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group mb-0">
                                                    <label class="font-weight-bold">Hora Inicio</label>
                                                    {{ form.hora_inicio }}
                                                    {% if form.hora_inicio.errors %}
                                                        <div class="invalid-feedback d-block">
                                                            {{ form.hora_inicio.errors.0 }}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group mb-0">
                                                    <label class="font-weight-bold">Hora Fin</label>
                                                    {{ form.hora_fin }}
                                                    {% if form.hora_fin.errors %}
                                                        <div class="invalid-feedback d-block">
                                                            {{ form.hora_fin.errors.0 }}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group mb-0">
                                                    <label class="font-weight-bold">Activo</label>
                                                    <div class="mt-2">
                                                        {{ form.activo }}
                                                        <label for="{{ form.activo.id_for_label }}" style="cursor: pointer; user-select: none;">
                                                            Usar
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {{ form.id }}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>

                    </div>

                    <!-- TAB 3: Excepciones -->
                    <div class="tab-pane fade {% if active_tab == 'excepciones' %}show active{% endif %}" 
                         id="excepciones" 
                         role="tabpanel">
                        
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-calendar-times"></i> Excepciones de Disponibilidad
                        </h5>
                        
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Vacaciones y Días Libres:</strong> Configure aquí los períodos en los que el dentista NO estará disponible 
                            (vacaciones, días libres, capacitaciones, etc.)
                        </div>

                        {{ excepcion_formset.management_form }}
                        
                        <div id="excepcion-formset">
                            {% for form in excepcion_formset %}
                                <div class="formset-row card mb-3">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label class="font-weight-bold">Fecha Inicio</label>
                                                    {{ form.fecha_inicio }}
                                                    {% if form.fecha_inicio.errors %}
                                                        <div class="invalid-feedback d-block">
                                                            {{ form.fecha_inicio.errors.0 }}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label class="font-weight-bold">Fecha Fin</label>
                                                    {{ form.fecha_fin }}
                                                    {% if form.fecha_fin.errors %}
                                                        <div class="invalid-feedback d-block">
                                                            {{ form.fecha_fin.errors.0 }}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label class="font-weight-bold">Tipo</label>
                                                    {{ form.tipo }}
                                                    {% if form.tipo.errors %}
                                                        <div class="invalid-feedback d-block">
                                                            {{ form.tipo.errors.0 }}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label class="font-weight-bold">Duración</label>
                                                    <div class="mt-2">
                                                        {{ form.todo_el_dia }}
                                                        <label for="{{ form.todo_el_dia.id_for_label }}" style="cursor: pointer; user-select: none;">
                                                            Todo el día
                                                        </label>
                                                    </div>
                                                    <small class="form-text text-muted">Desmarque para horario específico</small>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label class="font-weight-bold">Activo</label>
                                                    <div class="mt-2">
                                                        {{ form.estado }}
                                                        <label for="{{ form.estado.id_for_label }}" style="cursor: pointer; user-select: none;">
                                                            <span class="badge badge-success">Aplicar</span>
                                                        </label>
                                                    </div>
                                                    <small class="form-text text-muted">Desmarque para desactivar sin eliminar</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label class="font-weight-bold">Hora Inicio (opcional)</label>
                                                    {{ form.hora_inicio }}
                                                    <small class="form-text text-muted">Solo si no es todo el día</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label class="font-weight-bold">Hora Fin (opcional)</label>
                                                    {{ form.hora_fin }}
                                                    <small class="form-text text-muted">Solo si no es todo el día</small>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label class="font-weight-bold">Motivo</label>
                                                    {{ form.motivo }}
                                                </div>
                                            </div>
                                        </div>
                                        {{ form.id }}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Botón para agregar más excepciones -->
                        <div class="text-center mb-3">
                            <button type="button" id="add-excepcion" class="btn btn-outline-primary">
                                <i class="fas fa-plus-circle"></i> Agregar Otra Excepción
                            </button>
                        </div>

                    </div>
                    <!-- Fin Tab Excepciones -->

                <!-- Tab 4: Comisiones -->
                <div class="tab-pane fade {% if active_tab == 'comisiones' %}show active{% endif %}" 
                     id="comisiones" 
                     role="tabpanel" 
                     aria-labelledby="comisiones-tab">
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        Configure las comisiones que el dentista recibirá por cada especialidad que practica.
                        Puede elegir entre comisión por porcentaje o valor fijo.
                    </div>

                    <div class="table-responsive">
                        {{ comision_formset.management_form }}
                        
                        <table class="table table-bordered table-hover" id="comision-table">
                            <thead class="thead-light">
                                <tr>
                                    <th width="30%">Especialidad</th>
                                    <th width="20%">Tipo</th>
                                    <th width="15%">Porcentaje (%)</th>
                                    <th width="15%">Valor Fijo ($)</th>
                                    <th width="10%" class="text-center">Activo</th>
                                    <th width="10%" class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="comision-formset-body">
                                {% for form in comision_formset %}
                                <tr class="comision-form-row">
                                    <td>
                                        {{ form.especialidad }}
                                    </td>
                                    <td>
                                        {{ form.tipo_comision }}
                                    </td>
                                    <td>
                                        <div class="campo-porcentaje-container">
                                            {{ form.porcentaje }}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="campo-valor-fijo-container">
                                            {{ form.valor_fijo }}
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <div class="custom-control custom-checkbox">
                                            {{ form.activo }}
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        {% if form.instance.pk %}
                                            <button type="button" class="btn btn-sm btn-danger delete-comision" title="Eliminar comisión">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            <div style="display:none;">{{ form.DELETE }}</div>
                                        {% else %}
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-comision-row" title="Quitar fila">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        {% endif %}
                                        <!-- Ocultar observaciones -->
                                        <div style="display:none;">{{ form.observaciones }}{{ form.id }}</div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Botón para agregar más comisiones -->
                    <div class="text-center mb-3">
                        <button type="button" id="add-comision" class="btn btn-outline-success">
                            <i class="fas fa-plus-circle"></i> Agregar Comisión
                        </button>
                    </div>

                </div>
                <!-- Fin Tab Comisiones -->

            </div>
            <!-- Fin tab-content -->

        </div>
        <!-- Fin card-body -->

        <div class="card-footer">
            <div class="row">
                <div class="col-md-12 text-right">
                    <a href="{% url 'cit:dentista-list' %}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        {% if form.instance.pk %}
                            Actualizar Dentista
                        {% else %}
                            Guardar Dentista
                        {% endif %}
                    </button>
                </div>
            </div>
        </div>
        <!-- Fin card-footer -->
        
    </div>
    <!-- Fin card -->
    </form>
    
    <!-- Modal de Confirmación para Eliminar Comisión -->
    <div class="modal fade" id="deleteComisionModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle"></i> Confirmar Eliminación
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning mb-3">
                        <i class="fas fa-info-circle"></i>
                        <strong>Atención:</strong> Esta acción no se puede deshacer.
                    </div>
                    <p class="mb-0">
                        ¿Está seguro de que desea eliminar esta comisión?
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteComision">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block js_page %}
<script>
$(document).ready(function() {
    // Verificar que Select2 esté disponible
    if (typeof $.fn.select2 === 'undefined') {
        return;
    }
    
    // Destruir Select2 si ya existe (para evitar duplicados)
    if ($('.select2-especialidades').hasClass('select2-hidden-accessible')) {
        $('.select2-especialidades').select2('destroy');
    }
    if ($('.select2-sucursales').hasClass('select2-hidden-accessible')) {
        $('.select2-sucursales').select2('destroy');
    }
    
    // Inicializar Select2 para especialidades (múltiple)
    try {
        $('.select2-especialidades').select2({
            placeholder: 'Seleccione una o más especialidades...',
            allowClear: true,
            width: '100%',
            closeOnSelect: false,
            theme: 'default',
            language: {
                noResults: function() {
                    return "No se encontraron especialidades";
                }
            }
        });
    } catch (error) {
        // Error silencioso
    }

    // Inicializar Select2 para sucursales (múltiple)
    try {
        $('.select2-sucursales').select2({
            placeholder: 'Seleccione las sucursales donde atiende...',
            allowClear: true,
            width: '100%',
            closeOnSelect: false,
            theme: 'default',
            language: {
                noResults: function() {
                    return "No se encontraron sucursales";
                }
            }
        });
    } catch (error) {
        // Error silencioso
    }

    // Inicializar Select2 para sucursales en disponibilidad (simple)
    try {
        $('.select2-sucursal-disponibilidad').select2({
            placeholder: 'Seleccione sucursal...',
            allowClear: true,
            width: '100%',
            theme: 'default',
            language: {
                noResults: function() {
                    return "No se encontraron sucursales";
                }
            }
        });
    } catch (error) {
        // Error silencioso
    }

    // Validación del formulario
    $('#dentista-form').on('submit', function(e) {
        // Validar que tenga al menos una especialidad
        var especialidades = $('.select2-especialidades').val();
        if (!especialidades || especialidades.length === 0) {
            e.preventDefault();
            alert('Debe seleccionar al menos una especialidad');
            $('#datos-tab').tab('show');
            return false;
        }
    });

    // Mejorar la experiencia con tabs
    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
        // Guardar el tab activo en sessionStorage
        sessionStorage.setItem('activeTab', $(e.target).attr('href'));
    });

    // Restaurar el tab activo si existe
    var activeTab = sessionStorage.getItem('activeTab');
    if (activeTab) {
        $('a[href="' + activeTab + '"]').tab('show');
    }

    // Control de campos de hora en excepciones según "Todo el día"
    function toggleHorasExcepcion() {
        $('[id*="todo_el_dia"]').each(function() {
            var checkbox = $(this);
            var row = checkbox.closest('.card-body');
            
            // Buscar los campos de hora en la misma fila
            var horaInicioGroup = row.find('.form-group').filter(function() {
                return $(this).find('label:contains("Hora Inicio")').length > 0;
            });
            var horaFinGroup = row.find('.form-group').filter(function() {
                return $(this).find('label:contains("Hora Fin")').length > 0;
            });
            
            var horaInicio = row.find('[id*="hora_inicio"]').not('[id*="fecha"]');
            var horaFin = row.find('[id*="hora_fin"]').not('[id*="fecha"]');
            
            if (checkbox.is(':checked')) {
                // Ocultar campos de hora cuando está marcado "Todo el día"
                horaInicioGroup.hide();
                horaFinGroup.hide();
                horaInicio.prop('required', false);
                horaFin.prop('required', false);
            } else {
                // Mostrar campos de hora cuando NO está marcado "Todo el día"
                horaInicioGroup.show();
                horaFinGroup.show();
            }
        });
    }

    // Ejecutar al cargar la página con un pequeño delay para asegurar que el DOM esté listo
    setTimeout(toggleHorasExcepcion, 100);
    
    // Ejecutar cuando cambie cualquier checkbox "todo_el_dia"
    $(document).on('change', '[id*="todo_el_dia"]', toggleHorasExcepcion);

    // **NUEVO: Función para agregar más excepciones dinámicamente**
    $('#add-excepcion').click(function() {
        var formset = $('#excepcion-formset');
        var totalForms = $('#id_excepciones-TOTAL_FORMS');
        var formIdx = parseInt(totalForms.val());
        
        // Obtener la última fila como template
        var lastRow = formset.find('.formset-row').last();
        var newRow = lastRow.clone(true);
        
        // Actualizar los IDs y names de los campos
        newRow.find(':input').each(function() {
            var name = $(this).attr('name');
            var id = $(this).attr('id');
            
            if (name) {
                $(this).attr('name', name.replace(/-\d+-/, '-' + formIdx + '-'));
            }
            if (id) {
                $(this).attr('id', id.replace(/-\d+-/, '-' + formIdx + '-'));
            }
            
            // Limpiar valores excepto checkbox de estado y todo_el_dia
            if ($(this).attr('type') === 'checkbox') {
                if ($(this).attr('name').includes('estado')) {
                    // Dejar DESMARCADo el estado/Aplicar por defecto
                    $(this).prop('checked', false);
                } else if ($(this).attr('name').includes('todo_el_dia')) {
                    // Marcar "Todo el día" por defecto
                    $(this).prop('checked', true);
                }
            } else if ($(this).attr('type') !== 'hidden') {
                $(this).val('');
            }
        });
        
        // Actualizar labels for
        newRow.find('label').each(function() {
            var forAttr = $(this).attr('for');
            if (forAttr) {
                $(this).attr('for', forAttr.replace(/-\d+-/, '-' + formIdx + '-'));
            }
        });
        
        // Agregar la nueva fila
        formset.append(newRow);
        
        // Incrementar el contador
        totalForms.val(formIdx + 1);
        
        // Ejecutar toggle para la nueva fila
        setTimeout(toggleHorasExcepcion, 100);
        
        // Scroll suave a la nueva fila
        $('html, body').animate({
            scrollTop: newRow.offset().top - 100
        }, 500);
    });

    // ========================================================================
    // TAB COMISIONES - Toggle entre Porcentaje y Valor Fijo
    // ========================================================================
    
    // Función para mostrar/ocultar campos según el tipo de comisión
    function toggleComisionFields(row) {
        const tipoSelect = row.find('.tipo-comision-select');
        const tipoValor = tipoSelect.val();
        const porcentajeInput = row.find('.campo-porcentaje');
        const valorFijoInput = row.find('.campo-valor-fijo');
        
        if (tipoValor === 'PORCENTAJE') {
            porcentajeInput.prop('disabled', false).closest('div').show();
            valorFijoInput.prop('disabled', true).val('').closest('div').hide();
        } else if (tipoValor === 'FIJO') {
            valorFijoInput.prop('disabled', false).closest('div').show();
            porcentajeInput.prop('disabled', true).val('').closest('div').hide();
        } else {
            // Si no hay tipo seleccionado, mostrar ambos pero deshabilitados
            porcentajeInput.prop('disabled', true).closest('div').show();
            valorFijoInput.prop('disabled', true).closest('div').show();
        }
    }
    
    // Aplicar toggle a todas las filas existentes al cargar la página
    $('.comision-form-row').each(function() {
        toggleComisionFields($(this));
    });
    
    // Aplicar toggle cuando cambie el tipo de comisión
    $(document).on('change', '.tipo-comision-select', function() {
        const row = $(this).closest('.comision-form-row');
        toggleComisionFields(row);
    });
    
    // Inicializar Select2 para especialidades en comisiones
    try {
        $('.select2-comision-especialidad').select2({
            theme: 'bootstrap4',
            placeholder: 'Seleccione especialidad...',
            allowClear: true,
            width: '100%'
        });
    } catch (error) {
        // Silencioso - Select2 puede no estar disponible inicialmente
    }
    
    // ========================================================================
    // AGREGAR NUEVAS COMISIONES DINÁMICAMENTE
    // ========================================================================
    
    $('#add-comision').click(function(e) {
        e.preventDefault();
        
        const formsetBody = $('#comision-formset-body');
        const totalForms = $('#id_comisiones-TOTAL_FORMS');
        const formIdx = parseInt(totalForms.val());
        
        // Obtener la primera fila como plantilla (si existe)
        const templateRow = formsetBody.find('tr:first');
        
        if (templateRow.length === 0) {
            alert('No se pudo crear la nueva fila de comisión');
            return;
        }
        
        // Clonar la fila
        const newRow = templateRow.clone();
        
        // Actualizar los atributos name, id de todos los campos
        newRow.find(':input').each(function() {
            const name = $(this).attr('name');
            const id = $(this).attr('id');
            
            if (name) {
                $(this).attr('name', name.replace('-0-', '-' + formIdx + '-'));
            }
            if (id) {
                $(this).attr('id', id.replace('-0-', '-' + formIdx + '-'));
            }
            
            // Limpiar valores
            if ($(this).is(':checkbox')) {
                $(this).prop('checked', false); // Inactivo por defecto
            } else if (!$(this).attr('name') || !$(this).attr('name').includes('tipo_comision')) {
                $(this).val('');
            }
        });
        
        // Establecer tipo por defecto a PORCENTAJE
        newRow.find('.tipo-comision-select').val('PORCENTAJE');
        
        // Agregar la nueva fila al formset
        formsetBody.append(newRow);
        
        // Incrementar el contador de formas
        totalForms.val(formIdx + 1);
        
        // Aplicar toggle a la nueva fila
        toggleComisionFields(newRow);
        
        // Reinicializar Select2 en la nueva fila
        try {
            newRow.find('.select2-comision-especialidad').select2({
                theme: 'bootstrap4',
                placeholder: 'Seleccione especialidad...',
                allowClear: true,
                width: '100%'
            });
        } catch (error) {
            // Silencioso - Select2 puede no estar disponible
        }
        
        // Scroll suave hacia la nueva fila
        $('html, body').animate({
            scrollTop: newRow.offset().top - 100
        }, 500);
    });
    
    // ========================================================================
    // ELIMINAR COMISIONES
    // ========================================================================
    
    // Marcar comisión existente para eliminar (con confirmación)
    let rowToDelete = null;
    
    $(document).on('click', '.delete-comision', function(e) {
        e.preventDefault();
        rowToDelete = $(this).closest('tr');
        $('#deleteComisionModal').modal('show');
    });
    
    // Confirmar eliminación desde el modal
    $('#confirmDeleteComision').on('click', function() {
        if (rowToDelete) {
            const deleteCheckbox = rowToDelete.find('input[name$="-DELETE"]');
            
            // Marcar para eliminar
            deleteCheckbox.prop('checked', true);
            
            // Ocultar la fila con animación
            rowToDelete.fadeOut(300, function() {
                rowToDelete.addClass('d-none');
            });
            
            rowToDelete = null;
        }
        
        $('#deleteComisionModal').modal('hide');
    });
    
    // Quitar fila nueva (no guardada en BD)
    $(document).on('click', '.remove-comision-row', function(e) {
        e.preventDefault();
        
        const row = $(this).closest('tr');
        const formsetBody = $('#comision-formset-body');
        
        // Solo remover si hay más de una fila
        if (formsetBody.find('tr:visible').length > 1) {
            row.fadeOut(300, function() {
                row.remove();
                // Decrementar el contador
                const totalForms = $('#id_comisiones-TOTAL_FORMS');
                totalForms.val(parseInt(totalForms.val()) - 1);
            });
        } else {
            alert('Debe mantener al menos una fila de comisión');
        }
    });
});
</script>
{% endblock %}

